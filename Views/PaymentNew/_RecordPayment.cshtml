@model hongWenAPP.Models.PaymentNewModel.DTOs.CreatePaymentNewDTO

<form asp-action="RecordPayment" asp-controller="PaymentNew" method="post">
    <div class="modal-header">
        <h5 class="modal-title">Record Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
        @if (ViewBag.Invoice != null)
        {
            <div class="alert alert-info">
                <h6 class="mb-2">Invoice: @ViewBag.Invoice.InvoiceNumber</h6>
                <div class="d-flex justify-content-between">
                    <span>Total Amount:</span>
                    <strong>$@ViewBag.Invoice.TotalAmount.ToString("N2")</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Amount Paid:</span>
                    <strong>$@ViewBag.Invoice.AmountPaid.ToString("N2")</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Outstanding:</span>
                    <strong class="text-danger">$@ViewBag.Invoice.AmountOutstanding.ToString("N2")</strong>
                </div>
            </div>
        }

        <input type="hidden" asp-for="InvoiceId" />
        <input type="hidden" asp-for="StudentId" />
        <input type="hidden" asp-for="ReceivedBy" />

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Payment Amount <span class="text-danger">*</span></label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input asp-for="Amount" type="number" step="0.01" class="form-control" required />
                </div>
                <span asp-validation-for="Amount" class="text-danger"></span>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Payment Date <span class="text-danger">*</span></label>
                <input asp-for="PaymentDate" type="date" class="form-control" required />
                <span asp-validation-for="PaymentDate" class="text-danger"></span>
            </div>

            <div class="col-md-12 mb-3">
                <label class="form-label">Payment Method <span class="text-danger">*</span></label>
                <select asp-for="PaymentMethod" class="form-select" id="paymentMethodSelect" required>
                    @if (ViewBag.PaymentMethods != null)
                    {
                        @foreach (var method in ViewBag.PaymentMethods)
                        {
                            <option value="@method">@method</option>
                        }
                    }
                </select>
                <span asp-validation-for="PaymentMethod" class="text-danger"></span>
            </div>

            <!-- Bank Transfer Fields -->
            <div id="bankTransferFields" style="display:none;">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Transaction Reference</label>
                    <input asp-for="TransactionReference" type="text" class="form-control" placeholder="e.g., TXN-12345" />
                </div>

                <div class="col-md-12 mb-3">
                    <label class="form-label">Bank Reference</label>
                    <input asp-for="BankReference" type="text" class="form-control" placeholder="e.g., ABA-67890" />
                </div>
            </div>

            <!-- Check Fields -->
            <div id="checkFields" style="display:none;">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Check Number</label>
                    <input asp-for="CheckNumber" type="text" class="form-control" placeholder="e.g., CHK-001234" />
                </div>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Payer Name</label>
                <input asp-for="PayerName" type="text" class="form-control" placeholder="If different from student" />
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Payer Relationship</label>
                <select asp-for="PayerRelationship" class="form-select">
                    <option value="">Self</option>
                    <option value="Parent">Parent</option>
                    <option value="Guardian">Guardian</option>
                    <option value="Sponsor">Sponsor</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="col-md-12 mb-3">
                <label class="form-label">Notes</label>
                <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Any additional notes..."></textarea>
            </div>
        </div>

        <div class="alert alert-warning">
            <i class="bx bx-info-circle"></i>
            <strong>Important:</strong> After recording, payment status will be <strong>Pending</strong>. 
            A supervisor must confirm the payment to lock it.
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">
            <i class="bx bx-save"></i> Record Payment
        </button>
    </div>
</form>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Show/hide fields based on payment method
            $('#paymentMethodSelect').on('change', function () {
                const method = $(this).val();

                $('#bankTransferFields').hide();
                $('#checkFields').hide();

                if (method === 'BankTransfer' || method === 'ABA' || method === 'Wing' || method === 'TrueMoney') {
                    $('#bankTransferFields').show();
                } else if (method === 'Check') {
                    $('#checkFields').show();
                }
            });

            // Trigger on load
            $('#paymentMethodSelect').trigger('change');
        });
    </script>
}

