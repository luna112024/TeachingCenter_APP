@model CreatePaymentDTO

<form asp-action="AddPayment" asp-controller="Payment" method="post" autocomplete="off" id="addPaymentForm">
    <div class="modal-header">
        <h5 class="modal-title">üí∞ Record Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div class="alert alert-info">
            <strong>Note:</strong> Payments are <strong>IMMUTABLE</strong> once recorded. Cannot be edited or deleted.
            <br/>Use <strong>VOID</strong> function if you make a mistake.
        </div>

        <!-- Student Selection -->
        <div class="mb-3">
            <label class="form-label">Student<span class="text-danger">*</span></label>
            <select asp-for="StudentId" class="form-select" id="studentSelect" required>
                <option value="">Select Student</option>
            </select>
            <span asp-validation-for="StudentId" class="text-danger"></span>
        </div>

        <!-- Amount & Currency -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label" asp-for="Amount">Amount<span class="text-danger">*</span></label>
                <input asp-for="Amount" type="number" class="form-control" step="0.01" min="0.01" required placeholder="0.00"/>
                <span asp-validation-for="Amount" class="text-danger"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label" asp-for="Currency">Currency<span class="text-danger">*</span></label>
                <select asp-for="Currency" class="form-select" required>
                    <option value="USD">USD üíµ</option>
                    <option value="KHR">KHR ·üõ</option>
                </select>
            </div>
        </div>

        <!-- Payment Method -->
        <div class="mb-3">
            <label class="form-label" asp-for="PaymentMethodId">Payment Method<span class="text-danger">*</span></label>
            <select asp-for="PaymentMethodId" class="form-select" id="paymentMethodSelect" required>
                <option value="">Select Payment Method</option>
            </select>
            <span asp-validation-for="PaymentMethodId" class="text-danger"></span>
        </div>

        <!-- Payment Date -->
        <div class="mb-3">
            <label class="form-label" asp-for="PaymentDate">Payment Date<span class="text-danger">*</span></label>
            <input asp-for="PaymentDate" type="date" class="form-control" required />
            <span asp-validation-for="PaymentDate" class="text-danger"></span>
        </div>

        <!-- Payment For -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label" asp-for="PaymentFor">Payment For<span class="text-danger">*</span></label>
                <select asp-for="PaymentFor" class="form-select" required>
                    <option value="">Select Type</option>
                    <option value="Registration">Registration Fee</option>
                    <option value="Tuition">Tuition Fee</option>
                    <option value="Course Fee">Course Fee</option>
                    <option value="Support Fee">Support Fee</option>
                    <option value="Supply Fee">Supply Fee</option>
                    <option value="Enrollment Fee">Enrollment Fee</option>
                </select>
                <span asp-validation-for="PaymentFor" class="text-danger"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label" asp-for="Term">Term (Optional)</label>
                <input asp-for="Term" type="text" class="form-control" placeholder="e.g., 2025-Term1"/>
                <small class="text-muted">Leave empty if not applicable</small>
            </div>
        </div>

        <!-- Payer Information -->
        <div class="mb-3">
            <label class="form-label" asp-for="PayerName">Payer Name (Optional)</label>
            <input asp-for="PayerName" type="text" class="form-control" placeholder="Enter payer name if different from student"/>
        </div>

        <!-- Transaction Reference -->
        <div class="mb-3">
            <label class="form-label" asp-for="TransactionReference">Transaction Reference (Optional)</label>
            <input asp-for="TransactionReference" type="text" class="form-control" placeholder="Bank ref, ABA transaction ID, etc"/>
            <small class="text-muted">Required for Bank Transfer, ABA, Wing, TrueMoney</small>
        </div>

        <!-- Notes -->
        <div class="mb-3">
            <label class="form-label" asp-for="Notes">Notes (Optional)</label>
            <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Any additional notes"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">
            <i class="bx bx-save"></i> Record Payment
        </button>
    </div>
</form>

<script>
    $(document).ready(function() {
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        $('#PaymentDate').val(today);

        // Load students
        $.get('@Url.Action("GetStudents", "Payment")', function(students) {
            students.forEach(function(student) {
                $('#studentSelect').append(
                    `<option value="${student.studentId}">${student.studentName} (${student.studentCode})</option>`
                );
            });
        });

        // Load payment methods from database (pre-configured)
        $.get('/api/payment/methods', function(methods) {
            methods.forEach(function(method) {
                $('#paymentMethodSelect').append(
                    `<option value="${method.methodId}">${method.methodName}</option>`
                );
            });
        }).fail(function() {
            // Fallback: Static payment methods
            $('#paymentMethodSelect').append(`
                <option value="cash">Cash üíµ</option>
                <option value="bank">Bank Transfer üè¶</option>
                <option value="aba">ABA Pay üì±</option>
                <option value="wing">Wing üì±</option>
                <option value="truemoney">TrueMoney üì±</option>
            `);
        });

        // Form submission
        $('#addPaymentForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = $(this).serialize();
            
            $.post('@Url.Action("AddPayment", "Payment")', formData, function(response) {
                if (response.flag) {
                    toastr.success(response.message);
                    $('.modal').modal('hide');
                    location.reload();
                } else {
                    toastr.error(response.message);
                }
            });
        });
    });
</script>
