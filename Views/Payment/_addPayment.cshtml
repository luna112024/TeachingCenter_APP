<form asp-action="AddPayment" asp-controller="Payment" method="post" autocomplete="off" id="addPaymentForm">
    <div class="modal-header">
        <h5 class="modal-title">ðŸ’° Record Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div class="alert alert-info">
            <strong>Note:</strong> Payments are <strong>IMMUTABLE</strong> once recorded. Cannot be edited or deleted.
            <br/>Use <strong>VOID</strong> function if you make a mistake.
        </div>

        <!-- Student Selection -->
        <div class="mb-3">
            <label class="form-label">Student<span class="text-danger">*</span></label>
            <select name="StudentId" class="form-select" id="studentSelect" required>
                <option value="">Select Student</option>
            </select>
            <span class="text-danger" id="studentError"></span>
        </div>

        <!-- Amount & Currency -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Amount<span class="text-danger">*</span></label>
                <input name="Amount" type="number" class="form-control" step="0.01" min="0.01" required placeholder="0.00"/>
                <span class="text-danger" id="amountError"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Currency<span class="text-danger">*</span></label>
                <select name="Currency" class="form-select" required>
                    <option value="USD" selected>USD ðŸ’µ</option>
                    <option value="KHR">KHR áŸ›</option>
                </select>
            </div>
        </div>

        <!-- Payment Method -->
        <div class="mb-3">
            <label class="form-label">Payment Method<span class="text-danger">*</span></label>
            <select name="PaymentMethod" class="form-select" required>
                <option value="">Select Payment Method</option>
                <option value="Cash">Cash</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="ABA Pay">ABA Pay</option>
                <option value="Wing">Wing</option>
                <option value="TrueMoney">TrueMoney</option>
            </select>
            <span class="text-danger" id="paymentMethodError"></span>
        </div>

        <!-- Payment Date -->
        <div class="mb-3">
            <label class="form-label">Payment Date<span class="text-danger">*</span></label>
            <input name="PaymentDate" type="date" class="form-control" id="paymentDate" required />
            <span class="text-danger" id="paymentDateError"></span>
        </div>

        <!-- Payment For -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Payment For<span class="text-danger">*</span></label>
                <select name="PaymentFor" class="form-select" required>
                    <option value="">Select Type</option>
                    <option value="Registration">Registration Fee</option>
                    <option value="Tuition" selected>Tuition Fee</option>
                    <option value="Course Fee">Course Fee</option>
                    <option value="Support Fee">Support Fee</option>
                    <option value="Supply Fee">Supply Fee</option>
                    <option value="Enrollment Fee">Enrollment Fee</option>
                </select>
                <span class="text-danger" id="paymentForError"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Term (Optional)</label>
                <input name="Term" type="text" class="form-control" placeholder="e.g., 2025-Term1"/>
                <small class="text-muted">Leave empty if not applicable</small>
            </div>
        </div>

        <!-- Payer Information -->
        <div class="mb-3">
            <label class="form-label">Payer Name (Optional)</label>
            <input name="PayerName" type="text" class="form-control" placeholder="Enter payer name if different from student"/>
        </div>

        <!-- Transaction Reference -->
        <div class="mb-3">
            <label class="form-label">Transaction Reference (Optional)</label>
            <input name="TransactionReference" type="text" class="form-control" placeholder="Bank ref, ABA transaction ID, etc"/>
            <small class="text-muted">Required for Bank Transfer, ABA, Wing, TrueMoney</small>
        </div>

        <!-- Notes -->
        <div class="mb-3">
            <label class="form-label">Notes (Optional)</label>
            <textarea name="Notes" class="form-control" rows="3" placeholder="Any additional notes"></textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">
            <i class="bx bx-save"></i> Record Payment
        </button>
    </div>
</form>

<script>
    $(document).ready(function() {
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        $('#paymentDate').val(today);

        // Load students dynamically
        $.get('@Url.Action("GetStudents", "Payment")', function(students) {
            $('#studentSelect').empty().append('<option value="">Select Student</option>');
            students.forEach(function(student) {
                $('#studentSelect').append(
                    `<option value="${student.studentId}">${student.studentName} (${student.studentCode})</option>`
                );
            });
        }).fail(function() {
            toastr.error('Failed to load students');
        });

        // Form submission
        $('#addPaymentForm').on('submit', function(e) {
            e.preventDefault();
            
            // Clear previous errors
            $('.text-danger').text('');
            
            const formData = $(this).serialize();
            
            $.post('@Url.Action("AddPayment", "Payment")', formData, function(response) {
                if (response.flag) {
                    toastr.success(response.message);
                    $('.modal').modal('hide');
                    $('#listContainer').load('@Url.Action("ListPayment", "Payment")');
                } else {
                    toastr.error(response.message);
                }
            }).fail(function(xhr) {
                if (xhr.responseJSON && xhr.responseJSON.validationErrors) {
                    // Display validation errors
                    const errors = xhr.responseJSON.validationErrors;
                    for (const [key, messages] of Object.entries(errors)) {
                        const errorElementId = key.charAt(0).toLowerCase() + key.slice(1) + 'Error';
                        $(`#${errorElementId}`).text(messages.join(', '));
                    }
                } else {
                    toastr.error('Failed to record payment');
                }
            });
        });
    });
</script>
