@model hongWenAPP.Models.InvoiceModel.DTOs.ApplyDiscountDTO

@{
    var invoiceId = ViewBag.InvoiceId as Guid?;
}

<div class="modal-header">
    <h5 class="modal-title">
        <i class="bx bx-purchase-tag me-2"></i>Apply Discount to Invoice
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form id="applyDiscountForm" asp-action="ApplyDiscount" asp-controller="Invoice" asp-route-invoiceId="@invoiceId" method="post">
    <div class="modal-body">
        <div class="alert alert-warning">
            <i class="bx bx-info-circle me-2"></i>
            <strong>Note:</strong> You can apply a discount either as a fixed amount or as a percentage. Only one method can be used at a time.
        </div>

        <!-- Discount Method Selection -->
        <div class="mb-4">
            <label class="form-label">Discount Method</label>
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="discountMethod" id="methodAmount" value="amount" checked>
                <label class="btn btn-outline-primary" for="methodAmount">
                    <i class="bx bx-dollar-circle me-1"></i>Fixed Amount
                </label>

                <input type="radio" class="btn-check" name="discountMethod" id="methodPercentage" value="percentage">
                <label class="btn btn-outline-primary" for="methodPercentage">
                    <i class="bx bx-percentage me-1"></i>Percentage
                </label>
            </div>
        </div>

        <!-- Fixed Amount Input -->
        <div id="amountInput" class="mb-3">
            <label asp-for="DiscountAmount" class="form-label">Discount Amount <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text">$</span>
                <input asp-for="DiscountAmount" type="number" id="discountAmount" class="form-control" step="0.01" min="0" placeholder="0.00" />
            </div>
            <span asp-validation-for="DiscountAmount" class="text-danger"></span>
            <small class="form-text text-muted">Enter the discount amount in dollars</small>
        </div>

        <!-- Percentage Input -->
        <div id="percentageInput" class="mb-3" style="display: none;">
            <label asp-for="DiscountPercentage" class="form-label">Discount Percentage <span class="text-danger">*</span></label>
            <div class="input-group">
                <input asp-for="DiscountPercentage" type="number" id="discountPercentage" class="form-control" step="0.01" min="0" max="100" placeholder="0.00" />
                <span class="input-group-text">%</span>
            </div>
            <span asp-validation-for="DiscountPercentage" class="text-danger"></span>
            <small class="form-text text-muted">Enter the discount percentage (0-100)</small>
        </div>

        <!-- Discount Reason -->
        <div class="mb-3">
            <label asp-for="DiscountReason" class="form-label">Reason for Discount <span class="text-danger">*</span></label>
            <textarea asp-for="DiscountReason" class="form-control" rows="3" placeholder="Please provide a reason for this discount (e.g., Early payment, Special promotion, Financial assistance)" required></textarea>
            <span asp-validation-for="DiscountReason" class="text-danger"></span>
        </div>

        <!-- Preview Card -->
        <div class="card bg-label-info">
            <div class="card-body">
                <h6 class="card-title mb-3">Discount Preview</h6>
                <div class="row">
                    <div class="col-6">
                        <p class="mb-2"><strong>Discount Type:</strong></p>
                        <p id="previewType" class="text-primary">Fixed Amount</p>
                    </div>
                    <div class="col-6">
                        <p class="mb-2"><strong>Discount Value:</strong></p>
                        <p id="previewValue" class="text-primary">$0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Common Discount Quick Buttons -->
        <div class="mt-3">
            <label class="form-label">Quick Discounts (Percentage)</label>
            <div class="d-flex gap-2 flex-wrap">
                <button type="button" class="btn btn-sm btn-outline-secondary quick-discount" data-percent="5">5%</button>
                <button type="button" class="btn btn-sm btn-outline-secondary quick-discount" data-percent="10">10%</button>
                <button type="button" class="btn btn-sm btn-outline-secondary quick-discount" data-percent="15">15%</button>
                <button type="button" class="btn btn-sm btn-outline-secondary quick-discount" data-percent="20">20%</button>
                <button type="button" class="btn btn-sm btn-outline-secondary quick-discount" data-percent="25">25%</button>
                <button type="button" class="btn btn-sm btn-outline-secondary quick-discount" data-percent="50">50%</button>
            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bx bx-x me-1"></i>Cancel
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="bx bx-check me-1"></i>Apply Discount
        </button>
    </div>
</form>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Toggle between amount and percentage inputs
            $('input[name="discountMethod"]').on('change', function () {
                var method = $(this).val();
                if (method === 'amount') {
                    $('#amountInput').show();
                    $('#percentageInput').hide();
                    $('#discountPercentage').val('');
                    $('#discountAmount').prop('required', true);
                    $('#discountPercentage').prop('required', false);
                    updatePreview();
                } else {
                    $('#amountInput').hide();
                    $('#percentageInput').show();
                    $('#discountAmount').val('');
                    $('#discountAmount').prop('required', false);
                    $('#discountPercentage').prop('required', true);
                    updatePreview();
                }
            });

            // Quick discount buttons
            $('.quick-discount').on('click', function () {
                var percent = $(this).data('percent');
                $('#methodPercentage').prop('checked', true).trigger('change');
                $('#discountPercentage').val(percent);
                updatePreview();
            });

            // Update preview on input
            $('#discountAmount, #discountPercentage').on('input', function () {
                updatePreview();
            });

            function updatePreview() {
                var method = $('input[name="discountMethod"]:checked').val();
                
                if (method === 'amount') {
                    var amount = parseFloat($('#discountAmount').val()) || 0;
                    $('#previewType').text('Fixed Amount');
                    $('#previewValue').text('$' + amount.toFixed(2));
                } else {
                    var percentage = parseFloat($('#discountPercentage').val()) || 0;
                    $('#previewType').text('Percentage Discount');
                    $('#previewValue').text(percentage.toFixed(2) + '%');
                }
            }

            // Form validation before submission
            $('#applyDiscountForm').on('submit', function (e) {
                e.preventDefault();

                var method = $('input[name="discountMethod"]:checked').val();
                var amount = parseFloat($('#discountAmount').val()) || 0;
                var percentage = parseFloat($('#discountPercentage').val()) || 0;
                var reason = $('#DiscountReason').val().trim();

                // Validation
                if (method === 'amount' && amount <= 0) {
                    toastr.error('Please enter a valid discount amount greater than 0');
                    return;
                }

                if (method === 'percentage' && (percentage <= 0 || percentage > 100)) {
                    toastr.error('Please enter a valid discount percentage between 0 and 100');
                    return;
                }

                if (!reason) {
                    toastr.error('Please provide a reason for the discount');
                    return;
                }

                // Clear the unused field before submitting
                if (method === 'amount') {
                    $('#discountPercentage').val(0);
                } else {
                    $('#discountAmount').val(0);
                }

                // Submit form
                var formData = $(this).serialize();
                var actionUrl = $(this).attr('action');

                $.ajax({
                    url: actionUrl,
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        if (response.flag) {
                            toastr.success(response.message || 'Discount applied successfully');
                            $('.modal').modal('hide');
                            location.reload(); // Refresh to show updated invoice
                        } else {
                            toastr.error(response.message || 'Failed to apply discount');
                        }
                    },
                    error: function () {
                        toastr.error('An error occurred while applying the discount');
                    }
                });
            });

            // Initialize preview
            updatePreview();
        });
    </script>
}

